{% extends 'community/Base.html' %}

{% load static %}

{% block title %}
復刻穿搭
{% endblock %}

{% block style %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/0.9.15/css/jquery.Jcrop.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/0.9.15/js/jquery.Jcrop.js"></script>
    <style>
        div.loadingdiv {
            height: 100%;
            width: 100%;
            position: fixed;
            z-index: 99999;
            top: 0;
            left: 0;
            display: block;
            background: #000;
            opacity: 0.6;
            text-align: center;
        }

        div.loadingdiv img {
            position: relative;
            vertical-align: middle;
            text-align: center;
            margin: 0 auto;
            margin-top: 50vh;
        }
    </style>
{% endblock %}

{% block h1 %}
復刻穿搭
{% endblock %}

{% block content %}
    <div class="loadingdiv" style="display: none">
        <img src="{% static 'images/loading.gif' %}" />
    </div>
    <section class="main">
        <div class="addOutfit_left-col">
            <div class="post">
                <div class="info">
                    <div class="user">
                        <div class="profile-pic"> <img src="{{ post.user.profile_picture.url }}" alt=""> </div>
                        <p class="username" style="color: rgba(148,122,136,1);">{{ post.user.username }}</p>
                    </div>
                </div>
                <div class="post-image">
                    <form id="form" action="{% url 'select_remake' post.id %}" method="post">
                        {% csrf_token %}
                        <div class="post_camera_icon">
                            <img id="image" class="post-image" style="width: auto; display: block; margin-left: auto; margin-right: auto;" src="{{ post.image.url }}"/>
                            <canvas id="canvas" style="position: absolute; top: 8px;left: 8px"></canvas>
                        </div>
                        <button type="button" hidden=true id="confirm" onclick="getResult()" class="remake_submit1" > 選擇下一個</button>
                        <button type="submit" class="remake_submit2"> <a href="#popup2" style="color: rgba(255,254,247,1);"> 開始復刻 </button></a>
                    </form>
                </div>
                
                <div >
                    <div style="padding-bottom: 25px;"></div>
                    
                        <input type="text" class="remake_clothes_font" value="復刻單品" style="background-color:#f3f3f3; border:0; width: 90%; text-align: left;" />  

                    <hr size="1px" color= "#e6e6e6" width="100%"> 


                </div>
            </div>
            
        </div>
    
    </section>
{% endblock %}

{% block script %}
    <script>
        let img = document.getElementById("image");
        let element = document.getElementById("confirm");
        let hidden = element.getAttribute("hidden");
        var selectResult;
        var regions = [];
        $(document).ready(function(){
            // make canvas fit the image.
            let canvas = $('#canvas');
            let image = $('#image');
            canvas.width(image.width());
            canvas.height(image.height());

            image.Jcrop({
                onSelect: function(c){
                    if (hidden) {
                        element.removeAttribute("hidden");
                    }
                    selectResult = $(this).attr('result');
                    selectResult = [c.x,c.y,c.w,c.h]
                }
            })
        })
        function drawRectangle(left, top, width, height) {
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            var img = document.getElementById('image');
            context.beginPath();
            context.lineWidth = "4";
            context.strokeStyle = "white";
            context.rect(left, top, width, height);
            context.stroke();
        }
        function getResult() {
            drawRectangle(selectResult[0], selectResult[1], selectResult[2], selectResult[3]);
            regions.push(selectResult);
            element.setAttribute("hidden","False");
        }
        function postRegions() {
            let form = $("#form");
            for (let i = 0; i < regions.length; i++) {
                form.append('<input type="hidden" name="region' + i + '" value="' + JSON.stringify(regions[i]) + '" />');
            }
            form.append('<input type="hidden" name="img_height" value="' + $('#image').height() + '" />');
            return true;
        }

        $("#form").submit( function(e) {
            $(".loadingdiv").show();
            postRegions();
        })
    </script>
{% endblock %}